name: Sync i18n to S3

on:
  # 1. ê´€ë¦¬ì í˜ì´ì§€(CMS)ì—ì„œ ì›¹í›…ìœ¼ë¡œ í˜¸ì¶œí•  ë•Œ
  repository_dispatch:
    types: [sync_i18n]
  # 2. GitHub Actions íƒ­ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ë•Œ
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Install dependencies
        run: npm install google-spreadsheet google-auth-library dotenv

      # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (íƒ€ì„ìŠ¤íƒ¬í”„ ë²„ì „ìœ¼ë¡œ íŒŒì¼ ìƒì„±)
      - name: Generate JSON files
        run: node scripts/sync-i18n.js
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}

      # [ë””ë²„ê¹…] íŒŒì¼ì´ ì‹¤ì œë¡œ ì˜ ìƒì„±ë˜ì—ˆëŠ”ì§€ ë¡œê·¸ë¡œ í™•ì¸
      - name: Debug - Check Created Files
        run: |
          echo "ğŸ“‚ --- Created Files in ./locales ---"
          ls -R ./locales
          echo "-------------------------------------"

      # AWS ê¶Œí•œ ì„¤ì •
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 1ë‹¨ê³„: ë²ˆì—­ íŒŒì¼(*.json) ì—…ë¡œë“œ
      # ì„¤ëª…: locales í´ë” ë‚´ìš©ì„ ë²„í‚·ì˜ locales/ í´ë” ì•ˆìœ¼ë¡œ ë„£ìŠµë‹ˆë‹¤.
      # ì£¼ì˜: version.jsonì€ ì œì™¸í•˜ê³ , ìºì‹œë¥¼ 1ë…„(31536000ì´ˆ)ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Upload Translation Files (Long Cache)
        run: |
          aws s3 cp ./locales s3://${{ secrets.S3_BUCKET_NAME }}/locales/ \
            --recursive \
            --exclude "version.json" \
            --cache-control "public, max-age=31536000, immutable" \
            --acl public-read

      # 2ë‹¨ê³„: ë§¤ë‹ˆí˜ìŠ¤íŠ¸(version.json) ì—…ë¡œë“œ
      # ì„¤ëª…: ì´ íŒŒì¼ì€ í•­ìƒ ìµœì‹ ì´ì–´ì•¼ í•˜ë¯€ë¡œ ìºì‹œë¥¼ ë•ë‹ˆë‹¤(no-cache).
      - name: Upload Manifest File (No Cache)
        run: |
          aws s3 cp ./locales/version.json s3://${{ secrets.S3_BUCKET_NAME }}/locales/version.json \
            --cache-control "no-cache, no-store, must-revalidate" \
            --acl public-read